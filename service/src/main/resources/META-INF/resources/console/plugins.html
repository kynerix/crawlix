<!DOCTYPE html>
<html lang="en" class="pf-m-redhat-font">

<head>
    <title>Crawlix Console</title>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <link rel="stylesheet" href="css/patternfly.css">
    <link rel="stylesheet" href="css/patternfly-addons.css">
    <link rel="stylesheet" type="text/css" href="https://cdn.datatables.net/1.13.1/css/jquery.dataTables.min.css">

    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.2.1/jquery.min.js"></script>

    <script src="https://cdn.datatables.net/1.13.1/js/jquery.dataTables.js"></script>

    <!-- Console javascript -->
    <script src="js/console-common.js"></script>
</head>

<body>

    <div class="pf-c-page">

        <header class="pf-c-masthead" id="card-view-basic-example-masthead">
            <span class="pf-c-masthead__toggle">
                <button class="pf-c-button pf-m-plain" type="button" aria-label="Global navigation">
                    <i class="fas fa-bars" aria-hidden="true"></i>
                </button>
            </span>
            <div class="pf-c-masthead__main">
                <a class="pf-c-masthead__brand" href="#">
                    <picture class="pf-c-brand pf-m-picture"
                        style="--pf-c-brand--Width: 180px; --pf-c-brand--Width-on-md: 180px; --pf-c-brand--Width-on-2xl: 220px;">
                        <source media="(min-width: 768px)"
                            srcset="/console/css/assets/images/logo__pf--reverse-on-md.svg">
                        <source srcset="/assets/images/logo__pf--reverse--base.svg">
                        <img src="/assets/images/logo__pf--reverse--base.png" alt="Fallback patternFly default logo">
                    </picture>
                </a>
            </div>
            <div class="pf-c-masthead__content">
                <div class="pf-c-toolbar pf-m-full-height pf-m-static" id="card-view-basic-example-masthead-toolbar">
                    <div class="pf-c-toolbar__content">
                        <div class="pf-c-toolbar__content-section">
                            <div
                                class="pf-c-toolbar__group pf-m-icon-button-group pf-m-align-right pf-m-spacer-none pf-m-spacer-md-on-md">
                            </div>
                            <div class="pf-c-toolbar__item pf-m-hidden pf-m-visible-on-sm">
                                <div class="pf-c-dropdown pf-m-full-height" style="--pf-c-dropdown--MaxWidth: 20ch;">
                                    <button class="pf-c-dropdown__toggle"
                                        id="card-view-basic-example-masthead-profile-button" aria-expanded="false"
                                        type="button" onclick="toogle('userMenu')">
                                        <span class="pf-c-dropdown__toggle-image">
                                            <img class="pf-c-avatar" alt="Avatar image"
                                                src="/console/css/assets/images/img_avatar-light.svg">
                                        </span>
                                        <span class="pf-c-dropdown__toggle-text" id="username"></span>
                                        <span class="pf-c-dropdown__toggle-icon">
                                            <i class="fas fa-caret-down" aria-hidden="true"></i>
                                        </span>
                                    </button>
                                    <div class="pf-c-dropdown__menu" style="visibility:hidden" id="userMenu">
                                        <section class="pf-c-dropdown__group">
                                            <ul>
                                                <li>
                                                    <a class="pf-c-dropdown__menu-item" onclick="logout()">Logout</a>
                                                </li>
                                            </ul>
                                        </section>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </header>
        <!-- End of Header -->

        <!-- SIDEBAR BEGIN -->
        <div class="pf-c-page__sidebar">
            <div class="pf-c-page__sidebar-body">
                <nav class="pf-c-nav" id="compact-demo-primary-nav" aria-label="Global">
                    <ul class="pf-c-nav__list">
                        <li class="pf-c-nav__item">
                            <a href="/console/plugins.html" class="pf-c-nav__link pf-m-current"
                                aria-current="page">Plugins</a>
                        </li>
                        <li class="pf-c-nav__item">
                            <a href="/console/nodes.html" class="pf-c-nav__link">Crawler nodes</a>
                        </li>
                        <li class="pf-c-nav__item">
                            <a href="/console/workspaces.html" class="pf-c-nav__link">Workspaces</a>
                        </li>
                        <li class="pf-c-nav__item">
                            <a href="/console/jobs.html" class="pf-c-nav__link">Jobs</a>
                        </li>
                        <li class="pf-c-nav__item">
                            <a href="/console/resources.html" class="pf-c-nav__link">Resources</a>
                        </li>
                    </ul>
                </nav>
            </div>
        </div>
        <!-- SIDEBAR END -->

        <main class="pf-c-page__main" tabindex="-1">

            <!-- TITLE -->
            <section class="pf-c-page__main-section pf-m-limit-width pf-m-light">

                <div class="pf-c-page__main-body">

                    <div class="pf-c-content">
                        <h1>Plugins</h1>
                        <p>List of available crawler descriptors.</p>
                    </div>
                </div>
            </section>
            <!-- END OF TITLE -->

            <!-- BEGIN TABLE -->

            <section class="pf-c-page__main-section pf-m-no-padding pf-m-padding-on-xl">

                <!-- Alerts Success / Warning errors -->
                <div class="pf-c-alert pf-m-info" aria-label="Information alert"
                    style="margin-bottom: 20px; display: none;" id="successMsg">
                    <div class="pf-c-alert__icon">
                        <i class="fas fa-fw fa-info-circle" aria-hidden="true"></i>
                    </div>
                    <p class="pf-c-alert__title">
                        Operation has been successful.
                    </p>
                </div>

                <div class="pf-c-alert pf-m-danger" id="errorMsg" aria-label="Danger alert"
                    style="margin-bottom: 20px; display:none">
                    <div class="pf-c-alert__icon">
                        <i class="fas fa-fw fa-exclamation-circle" aria-hidden="true"></i>
                    </div>
                    <p class="pf-c-alert__title">
                        <span id="errorTxt"></span>
                    </p>
                </div>
                <!-- End of alerts / Errors -->

                <div class="pf-c-card" style="padding: 20px">
                    <table id="data-table" class="display compact" style="width:100%">
                        <thead>
                            <tr>
                                <th>Key</th>
                                <th>Workspace</th>
                                <th>Status</th>
                                <th>Last update</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                    </table>
                </div>
            </section>

            <!-- END TABLE -->
        </main>
    </div>

    <!----------------------------------------------------------------------------------------------------------------->

    <div class="pf-c-backdrop" id="pluginResultsModal" style="visibility:hidden">
        <div class="pf-l-bullseye">
            <div class="pf-c-modal-box pf-m-lg" role="dialog" aria-modal="true" aria-labelledby="modal-scroll-title"
                aria-describedby="modal-scroll-description">
                <button class="pf-c-button pf-m-plain" type="button" aria-label="Close dialog"
                    onclick="hide('pluginResultsModal');">
                    <i class="fas fa-times" aria-hidden="true"></i>
                </button>
                <header class="pf-c-modal-box__header">
                    <h1 class="pf-c-modal-box__title" id="modal-scroll-title">Plugin execution results</h1>
                    <div class="pf-c-modal-box__description" id="modal-scroll-description"></div>
                </header>
                <div class="pf-c-modal-box__body" tabindex="0">
                    <div class="pf-c-code-block__content">
                        <pre
                            class="pf-c-code-block__pre"><code class="pf-c-code-block__code" id="pluginJSON"></code></pre>
                    </div>
                </div>
                <footer class="pf-c-modal-box__footer">
                    <button class="pf-c-button pf-m-primary" type="button"
                        onclick="hide('pluginResultsModal');">Close</button>
                </footer>
            </div>
        </div>
    </div>

    <!----------------------------------------------------------------------------------------------------------------->

    <div class="pf-c-backdrop" id="pluginDetailsModal" style="visibility:hidden">
        <div class="pf-l-bullseye">
            <div class="pf-c-modal-box pf-m-lg" role="dialog" aria-modal="true" aria-labelledby="modal-scroll-title"
                aria-describedby="modal-scroll-description">
                <button class="pf-c-button pf-m-plain" type="button" aria-label="Close dialog"
                    onclick="hide('pluginDetailsModal');">
                    <i class="fas fa-times" aria-hidden="true"></i>
                </button>
                <header class="pf-c-modal-box__header">
                    <h1 class="pf-c-modal-box__title">Plugin details</h1>
                    <div class="pf-c-modal-box__description"></div>
                </header>
                <div class="pf-c-modal-box__body" tabindex="0">
                    <div class="pf-c-code-block__content">
                        <pre
                            class="pf-c-code-block__pre"><code class="pf-c-code-block__code" id="pluginDetails"></code></pre>
                    </div>
                </div>
                <footer class="pf-c-modal-box__footer">
                    <button class="pf-c-button pf-m-primary" type="button"
                        onclick="hide('pluginDetailsModal');">Close</button>
                </footer>
            </div>
        </div>
    </div>

    <!----------------------------------------------------------------------------------------------------------------->

    <script>

        function initTable() {
            // DataTable Config
            $("#data-table").DataTable({
                columns: [
                    { data: "key" },
                    { data: "workspace" },
                    {
                        render: function (data, type, rowData, meta) {
                            return renderIcon(rowData.status, ["ENABLED"], ["DISABLED"]) + rowData.status;
                        }
                    },
                    {
                        render:
                            function (data, type, rowData, meta) {
                                return renderDate(rowData.lastUpdate);
                            }
                    },
                    {
                        data: null,
                        render: function (data, type, full, meta) {
                            // Inline action kebab renderer
                            return renderMenu(
                                [
                                    { title: "View", action: "loadPlugin('" + data.workspace + "', '" + data.key + "', showPluginDetails)" },
                                    { separator: true },
                                    { title: "Enable", action: "enablePlugin('" + data.workspace + "', '" + data.key + "', refreshTable)" },
                                    { title: "Disable", action: "disablePlugin('" + data.workspace + "', '" + data.key + "', refreshTable)" },
                                    { separator: true },
                                    { title: "Run Test", action: "testPlugin('" + data.workspace + "', '" + data.key + "', showPluginResults)" },
                                    { title: "Execute", action: "executePlugin('" + data.workspace + "', '" + data.key + "', showPluginResults)" },
                                    //{ separator: true },
                                    //{ title: "Delete", action: "deletePlugin('" + data.key + "', refreshTable)" },
                                ]);
                        }
                    }
                ],
                order: [[0, 'desc']],
                ajax: function (data, callback, settings) {
                    sendRequest("GET", "/admin/list-plugins", function (data) {
                        callback({ data: data });
                    });
                }
            });
        }

        $(document).ready(function () {
            if (checkAuthentication()) {
                initTable();
            }
        });

        function showPluginResults(data) {
            update('pluginJSON', JSON.stringify(data, null, 4));
            show('pluginResultsModal');
            refreshTable();
        }

        function showPluginDetails(data) {
            update('pluginDetails', JSON.stringify(data, null, 4));
            show('pluginDetailsModal');
            refreshTable();
        }
    </script>
</body>

</html>